# 更新日志

## [0.3.2] - 2025-10-30

### 行为变更
- 默认在分析完成后删除截图文件，控制台输出删除提示（例如：`已删除截图: <路径>`）。

### 新增参数
- `--keep-screenshots`（环境变量：`KEEP_SCREENSHOTS=1`）：启用后保留截图并在日志写入 `screenshot_path`。
- 在 `--test-prompt` 模式运行时，强制保留当次截图。

---

## [0.3.1] - 2025-9-2

### 新增功能 🚀
- **窗口切换追踪系统**: 全新的窗口活动监控和分析功能
  - 实时窗口切换检测与历史记录
  - 窗口使用时间统计和应用使用分析
  - 智能缓存机制，避免频繁查询相同状态
  - 每分钟切换频率计算和会话时长跟踪

### 平台优化 🔧
- **macOS**: 
  - 保持现有 AppleScript 方法作为基础实现
  - 添加时间戳来跟踪窗口切换频率
  - 优化 AppleScript 查询，减少系统调用次数
  - 实现窗口信息缓存，提升性能

- **Windows**: 
  - 使用原生 Windows API 获取窗口信息
  - 支持进程ID获取和应用名称解析
  - 实时窗口边界和位置信息

### 增强的上下文信息 📊
- 新增窗口切换统计信息到系统上下文
- 包含最近5次窗口切换历史
- 显示最常用的应用程序和使用时长
- 当前会话和平均会话时长统计

### 技术改进 ⚡
- 新增 `window_tracker` 模块，提供完整的窗口追踪功能
- 增强 `ActiveWindowInfo` 结构，包含时间戳和进程信息
- 优化上下文信息格式化，包含详细的窗口活动数据

- 简化统计计算，专注于核心指标（总切换次数、应用使用时间）
- 移除网络接口信息，简化系统上下文结构
- 移除内核版本、开机时长、系统内存等系统信息
- 简化进程信息显示，移除内存使用量，按CPU使用率排序

### 数据结构
- `WindowSwitchEvent`: 窗口切换事件记录
- `WindowSession`: 窗口会话信息
- `WindowSwitchStats`: 窗口切换统计数据
- `EnhancedWindowInfo`: 增强的窗口信息（含时间戳和进程ID）

---

## [0.3.0] - 2025-8-31

### 🔧 重大重构 - 配置简化优化
- **统一数据目录**: 简化配置参数，移除 `--screenshot-dir` 和 `--log-path` 参数
- **固定目录结构**: 采用标准的数据目录结构，所有数据统一存储在 `--data-dir` 下
  - `screenshots/` - 截图文件
  - `logs/` - 按日期分类的日志文件
  - `service_state.json` - 服务状态文件
- **默认路径优化**: 
  - macOS: `~/Library/Application Support/ScreenTime/`
  - Linux: `~/.local/share/screentime/`
  - Windows: `%APPDATA%/ScreenTime/`

### 💰 新增功能 - Token使用统计
- **Token消耗记录**: 每次AI分析都会记录详细的token使用信息
  - 输入token数量 (`prompt_tokens`)
  - 输出token数量 (`completion_tokens`) 
  - 总token数量 (`total_tokens`)
- **模型信息记录**: 日志中包含使用的AI模型名称
- **实时显示**: 控制台实时显示每次分析的token消耗统计

### 📅 日志系统优化
- **按日期分类存储**: 日志文件按天分别保存 (格式: `YYYY-MM-DD.json`)
- **扩展日志结构**: ActivityLog增加 `model` 和 `token_usage` 字段
- **智能读取**: 支持读取最近N天的日志，自动聚合数据

### 🚮 移除功能
- **移除向后兼容**: 不再支持旧的日志格式和路径配置
- **简化参数**: 移除复杂的路径配置选项，采用约定大于配置的理念
- **清理代码**: 移除所有向后兼容相关的代码逻辑

### 🔧 改进
- **API响应优化**: 重构 `analyze_screenshot_with_prompt` 返回详细分析结果
- **MCP服务更新**: 自动使用新的按日期存储的日志系统
- **目录自动创建**: 程序自动创建必要的目录结构

### 📚 文档
- **README更新**: 反映新的配置方式和功能
- **参数文档**: 更新命令行参数说明，移除废弃参数

## [0.2.2] - 2025-8-25

### 🖼️ 新增功能
- **智能图片处理系统**: 完全重构图片处理流程
  - **专门的图片处理功能**: 添加了 `process_image_for_analysis` 函数
  - **自动灰度转换**: 将截图转换为灰度图，减少颜色信息干扰
  - **智能缩放**: 支持自定义目标宽度，默认1440像素，保持原始宽高比
  - **高质量算法**: 使用Lanczos3算法进行缩放，确保图片质量
  - **参数化控制**: 添加了 `--image-target-width` 和 `--image-grayscale` 命令行参数
  - **环境变量支持**: 支持通过 `IMAGE_TARGET_WIDTH` 和 `IMAGE_GRAYSCALE` 环境变量配置
  - **灵活尺寸控制**: 支持设置为0保持原图尺寸，提供更大的灵活性
  - **性能优化**: 减少图片文件大小，提高AI分析效率和API响应速度

### 🔧 改进
- 图片处理流程完全重构，支持参数化控制
- 改进配置信息输出，显示图片处理参数
- 优化代码结构，提升整体分析性能
- 改进图片质量，为AI分析提供更好的输入

### 📚 文档
- 更新README文档，添加新参数的使用说明
- 更新命令行参数表格和环境变量配置示例
- 添加完整的图片处理功能说明

### 🐛 修复
- 无

---

## [0.2.0] - 2025-8

### ✨ 新增功能
- **自定义API端点支持**: 添加了 `--api-url` 命令行参数和 `SILICONFLOW_API_URL` 环境变量
- 支持配置自定义的 SiliconFlow API 端点，适用于私有部署和企业环境
- 保持向后兼容，默认使用官方API端点

### 🔧 改进
- 增强配置灵活性，支持更多部署场景
- 改进错误处理和用户反馈

### 📚 文档
- 更新README文档，添加新功能使用说明
- 添加自定义API端点的详细使用指南
- 新增更新日志部分

### 🐛 修复
- 无

---

## [0.1.0] - 2025-8

### 🎉 初始版本
- **基础屏幕时间监控**: 定期截取屏幕截图并分析用户活动
- **AI智能分析**: 集成SiliconFlow多模态模型进行图像分析
- **MCP服务支持**: 提供Model Context Protocol服务，支持远程控制
- **系统上下文收集**: 自动收集系统信息、进程状态、窗口信息等
- **权限管理**: 自动检查和请求必要的系统权限
- **活动日志**: 完整的JSON格式活动记录
- **Web服务**: 内置SSE服务器支持实时数据推送
- **跨平台支持**: 支持macOS和Windows系统
- **测试功能**: 支持使用新prompt重新分析现有截图，便于优化分析效果

### 🔧 技术特性
- 使用Rust编写，高性能和内存安全
- 异步处理，支持高并发
- 模块化设计，易于扩展
- 完整的错误处理和日志记录
